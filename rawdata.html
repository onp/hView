<!doctype html>

<html lang=en>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Is it cold?">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>hView</title>

  <style>
  td {
    border: 1px solid black;
    width: 6em;
    text-align: center;
  }
  </style>

</head>

<body>
<h1>hView</h1>
<div id=content>
  <p>Waiting for data...</p>
</div>


<script src="https://www.gstatic.com/firebasejs/5.8.4/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.8.4/firebase-firestore.js"></script>
<script src="lib/d3.js"></script>
<script>
  // Initialize Firebase
  firebase.initializeApp({
    apiKey: "AIzaSyCch8gDaGfQhOFVroFCZHKosa3oOU-WvPE",
    authDomain: "templogger-233703.firebaseapp.com",
    projectId: "templogger-233703",
  });
  var db = firebase.firestore();
</script>

<script>
  //ref for content node
  var ct = document.querySelector('#content')
  var today = new Date()
  var todayStr = today.getFullYear() + '-' + (today.getMonth()+1) + "-" + (today.getDate())
  todayStr = "2019-11-28"

  // setup margins for plot area
  var m = [80, 80, 100, 80],
    w = window.innerWidth - m[1] - m[3],
    h = window.innerHeight - m[0] - m[2];

  //get temp data for current day
  var doc = db.collection("tempDaily").doc(todayStr);
  doc.get().then(function(qs) {
    var d1 = qs.data()

    //ct.textContent = d1.data;
    makePlot(d1.data)

  })

  function makePlot(data){
    var d = d3.csvParse("date,temp,humidity\n" + data,
                        //d3.autoType
                      function(d){
                        return {date: new Date(d.date.slice(1,-1)),
                                humidity: d.humidity,
                                temp: d.temp
                               }
                      })

    console.log(d)

    var svg = d3.select("#content").text("").append("svg")

    svg.attr("width", w + m[1] + m[3] - 1)
       .attr("height", h + m[0] + m[2])

    var plt = svg.append("g")
             .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

    var x = d3.scaleTime()
                  .domain(d3.extent(d, d => d.date))
                  .range([0, w]);

    var y1 = d3.scaleLinear()
                  .domain(d3.extent(d, d => d.temp))
                  .range([h, 0]);

    var y2 = d3.scaleLinear()
                  .domain(d3.extent(d, d => d.humidity))
                  .range([h, 0]);

    console.log(x.domain())
    console.log(y1.domain())

    var lineTemp = d3.line()
                .x(d => x(d.date))
                .y(d => y1(d.temp))

    var lineHum = d3.line()
                .x(d => x(d.date))
                .y2(d => y2(d.humidity))

    plt.append("g")
        .attr("class", "axis")
        .call(d3.axisLeft(y1));
    plt.append("g")
        .attr("class", "axis")
        .call(d3.axisRight(y2));
    plt.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(0," + h + ")")
        .call(d3.axisBottom(x))
        //.attr("transform", "translate(0," + y1(0) + ")");

    // Add lines.
    datalines = plt.append("svg:g")
    datalines.append("path")
          .datum(d)
          .attr("d", lineTemp(d))
          .attr("stroke", "red")
          .attr("stroke-width", 1.5);
          .attr("fill", "none")
    datalines.append("path")
          .datum(d)
          .attr("d", lineHum(d))
          .attr("stroke", "blue")
          .attr("stroke-width", 1.5);
          .attr("fill", "none")
  }


</script>

</body>
</html>
