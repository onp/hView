<!doctype html>

<html lang=en>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Is it cold?">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>hView</title>

  <style>

body {
width: 100%;
overflow-x: hidden;
position: relative;

}

h1 a{
  color:black;
  text-decoration: none;
}

  </style>

</head>

<body>
<h1><a href="/">hView</a></h1>
<div id=content>
  <p>Waiting for data...</p>
</div>
<label>Date</label><input type="date" id="startDate"></input>


<script src="https://www.gstatic.com/firebasejs/5.8.4/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.8.4/firebase-firestore.js"></script>
<script src="lib/d3.js"></script>
<script>
  // Initialize Firebase
  firebase.initializeApp({
    apiKey: "AIzaSyCch8gDaGfQhOFVroFCZHKosa3oOU-WvPE",
    authDomain: "templogger-233703.firebaseapp.com",
    projectId: "templogger-233703",
  });
  var db = firebase.firestore();
</script>

<script>

  function pad(num){
    return num.toString().padStart(2,0)
  }

  //ref for date input
  var dt = document.querySelector('#startDate')

  var today = new Date()
  var todayStr = today.getFullYear() + '-' + pad(today.getMonth()+1) + "-" + pad(today.getDate())

  dt.value = todayStr

  topOfContent = d3.select("#content").node().offsetTop
  // setup margins for plot area      t, r, b, l
  var m = [10, 80, 80, 80],
    w = window.innerWidth - m[1] - m[3],
    h = window.innerHeight - m[0] - m[2] - topOfContent;

  //get temp data for current day
  var doc = db.collection("tempDaily").doc(todayStr);
  doc.get().then(function(qs) {
    console.log(qs)
    var d1 = qs.data()

    makePlot(d1.data)

  })

  function makePlot(data){
    var d = d3.csvParse("date,temp,humidity\n" + data,
                        //d3.autoType
                      function(d){
                        return {date: new Date(d.date.slice(1,-1)),
                                humidity: +d.humidity,
                                temp: +d.temp
                               }
                      })
    d = d.filter(d => !isNaN(d.humidity))
    console.log(d)

    var svg = d3.select("#content").text("").append("svg")

    svg.attr("width", w + m[1] + m[3] - 1)
       .attr("height", h + m[0] + m[2])

    var plt = svg.append("g")
             .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

    var x = d3.scaleTime()
                  .domain(d3.extent(d, d => d.date))
                  .range([0, w]);

    var y1 = d3.scaleLinear()
                  .domain(d3.extent(d, d => d.temp))
                  .range([h, 0]);

    var y2 = d3.scaleLinear()
                  .domain(d3.extent(d, d => d.humidity))
                  .range([h, 0]);

    console.log(x.domain())
    console.log(y1.domain())

    var lineTemp = d3.line()
                .x(d => x(d.date))
                .y(d => y1(d.temp))

    var lineHum = d3.line()
                .x(d => x(d.date))
                .y(d => y2(d.humidity))

    plt.append("g")
        .attr("class", "axis")
        .call(d3.axisLeft(y1));
    plt.append("g")
        .attr("class", "axis")
        .call(d3.axisRight(y2))
        .attr("transform", "translate("+ w + ",0)");
    plt.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(0," + h + ")")
        .call(d3.axisBottom(x));
        //.attr("transform", "translate(0," + y1(0) + ")");

    // Add lines.
    datalines = plt.append("svg:g");
    datalines.append("path")
          .datum(d)
          .attr("d", lineTemp(d))
          .attr("stroke", "red")
          .attr("stroke-width", 1.5)
          .attr("fill", "none");
    datalines.append("path")
          .datum(d)
          .attr("d", lineHum(d))
          .attr("stroke", "blue")
          .attr("stroke-width", 1.5)
          .attr("fill", "none");
  }


</script>

</body>
</html>
